---
sidebar_position: 2
---

# Vulnerability Scanning

Understand how dpendx extracts dependencies and queries for vulnerabilities.

## Dependency Extraction

dpendx extracts dependencies from two types of files:

### Manifest Files

Primary configuration files that declare direct dependencies:

| Ecosystem | File | Example Content |
|-----------|------|-----------------|
| Go | go.mod | `require github.com/pkg/errors v0.9.1` |
| npm | package.json | `"lodash": "^4.17.20"` |
| Python | requirements.txt | `requests==2.25.0` |
| Python | pyproject.toml | `requests = "^2.25"` |
| Rust | Cargo.toml | `serde = "1.0"` |
| Ruby | Gemfile | `gem 'rails', '~> 7.0'` |
| Java | pom.xml | `<dependency>...<version>2.0</version>` |
| .NET | *.csproj | `<PackageReference Include="..." />` |
| PHP | composer.json | `"monolog/monolog": "^2.0"` |
| CocoaPods | Podfile | `pod 'Alamofire', '~> 5.0'` |

### Lock Files

Generated files that pin exact versions including transitive dependencies:

| Ecosystem | File | What It Contains |
|-----------|------|------------------|
| Go | go.sum | Checksums for all modules |
| npm | package-lock.json | Full dependency tree with exact versions |
| npm | yarn.lock | Yarn's version of the lock file |
| Python | poetry.lock | Poetry's resolved dependencies |
| Python | Pipfile.lock | Pipenv's resolved dependencies |
| Rust | Cargo.lock | Resolved crate versions |
| Ruby | Gemfile.lock | Bundler's resolved gems |
| .NET | packages.lock.json | NuGet resolved packages |
| PHP | composer.lock | Composer's resolved packages |
| CocoaPods | Podfile.lock | CocoaPods resolved pods |

:::tip Why Lock Files Matter
Lock files provide the complete dependency tree with exact versions, making vulnerability scanning more accurate. dpendx prioritizes lock files when both manifest and lock files exist.
:::

## Dependency Model

Each extracted dependency follows this model:

```go
type Dependency struct {
    Name      string // Package name
    Version   string // Exact version
    Ecosystem string // OSV ecosystem identifier
    Direct    bool   // Direct or transitive
    Source    string // Which file it came from
}
```

Example:

```go
Dependency{
    Name:      "lodash",
    Version:   "4.17.20",
    Ecosystem: "npm",
    Direct:    true,
    Source:    "package-lock.json",
}
```

## OSV Database Queries

For each dependency, dpendx queries the [OSV (Open Source Vulnerabilities)](https://osv.dev) database.

### Query Format

```json
POST https://api.osv.dev/v1/query

{
  "package": {
    "name": "lodash",
    "ecosystem": "npm"
  },
  "version": "4.17.20"
}
```

### Response Format

```json
{
  "vulns": [
    {
      "id": "GHSA-35jh-r3h4-6jhm",
      "aliases": ["CVE-2021-23337"],
      "summary": "Command Injection in lodash",
      "severity": [
        {
          "type": "CVSS_V3",
          "score": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H"
        }
      ],
      "affected": [
        {
          "ranges": [
            {
              "type": "SEMVER",
              "events": [
                {"introduced": "0"},
                {"fixed": "4.17.21"}
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

### Ecosystem Mapping

dpendx maps package ecosystems to OSV identifiers:

| dpendx Ecosystem | OSV Ecosystem |
|------------------|---------------|
| Go | `Go` |
| npm | `npm` |
| Python | `PyPI` |
| Rust | `crates.io` |
| Ruby | `RubyGems` |
| Java | `Maven` |
| .NET | `NuGet` |
| PHP | `Packagist` |
| CocoaPods | `CocoaPods` |

## Caching Strategy

To minimize API calls and improve performance, dpendx implements a caching layer:

### Cache Configuration

```go
type Cache struct {
    entries map[string]cacheEntry
    ttl     time.Duration // Default: 4 hours
    mu      sync.RWMutex
}
```

### Cache Key

```
ecosystem:package:version
```

Example: `npm:lodash:4.17.20`

### Cache Behavior

1. **On query**: Check cache first
2. **Cache hit**: Return cached vulnerabilities
3. **Cache miss**: Query OSV, cache result
4. **TTL expiry**: Entry evicted after 4 hours

The cache runs a cleanup goroutine every 30 minutes to evict expired entries.

## Rate Limiting

dpendx limits concurrent OSV queries using a semaphore:

```go
const maxConcurrentOSVRequests = 10

sem := make(chan struct{}, maxConcurrentOSVRequests)

// Before each query
sem <- struct{}{} // Acquire
defer func() { <-sem }() // Release
```

This prevents overwhelming the OSV API during scans of large dependency trees.

## Retry Logic

Failed OSV queries are retried with exponential backoff:

```go
func (c *Client) queryWithRetry(pkg Dependency) ([]Vulnerability, error) {
    for attempt := 0; attempt < 3; attempt++ {
        vulns, err := c.query(pkg)
        if err == nil {
            return vulns, nil
        }

        // Exponential backoff: 1s, 2s, 4s
        time.Sleep(time.Second * time.Duration(1<<attempt))
    }
    return nil, fmt.Errorf("OSV query failed after 3 attempts")
}
```

## Vulnerability Model

Vulnerabilities are normalized to this model:

```go
type Vulnerability struct {
    ID             string   // OSV ID (GHSA-xxxx or CVE-xxxx)
    Aliases        []string // Alternative IDs
    Summary        string   // Brief description
    Details        string   // Full description
    Severity       string   // CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN
    FixedVersion   string   // Version that fixes the issue
    AffectedRanges string   // Vulnerable version range
    URL            string   // Advisory URL
}
```

### Severity Mapping

dpendx maps CVSS scores to severity levels:

| CVSS Score | Severity |
|------------|----------|
| 9.0 - 10.0 | CRITICAL |
| 7.0 - 8.9 | HIGH |
| 4.0 - 6.9 | MEDIUM |
| 0.1 - 3.9 | LOW |
| No score | UNKNOWN |

## Performance Considerations

### Scan Optimization

For faster scans:

1. **Use lock files**: Provides exact versions without resolution
2. **Keep dependencies updated**: Fewer vulnerabilities = faster queries
3. **Remove unused dependencies**: Smaller dependency tree

### Typical Performance

| Dependencies | Cache State | Scan Time |
|--------------|-------------|-----------|
| 50 | Cold | 2-5 seconds |
| 50 | Warm | < 1 second |
| 200 | Cold | 5-10 seconds |
| 200 | Warm | 1-2 seconds |

## Next Steps

- [Learn about reachability analysis](/core-concepts/reachability-analysis)
- [Understand check run outcomes](/core-concepts/check-run-outcomes)
- [Explore the OSV database](/core-concepts/osv-database)
